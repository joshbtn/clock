<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clock Sync Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0a0a0a; color: #fbbf24; }
        .card { background-color: #171717; border: 1px solid #262626; }
        .toggle-input {
            appearance: none;
            width: 3rem;
            height: 1.5rem;
            background-color: #3f3f46;
            border-radius: 9999px;
            cursor: pointer;
            outline: none;
            transition: background-color 0.3s;
            position: relative;
        }
        .toggle-input:checked {
            background-color: #f59e0b;
        }
        .toggle-input::after {
            content: '';
            position: absolute;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background-color: white;
            top: 0.125rem;
            left: 0.125rem;
            transition: left 0.3s;
        }
        .toggle-input:checked::after {
            left: 1.625rem;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-2xl space-y-4">
        <!-- Main Card -->
        <div class="card p-6 rounded-2xl shadow-2xl">
            <h1 class="text-2xl font-bold mb-2 text-center">Clock Dashboard</h1>
            <p class="text-neutral-500 text-sm mb-6 text-center">Time Sync.</p>
            
            <div id="status" class="mb-6 p-3 rounded-lg bg-neutral-900 border border-neutral-800 text-center text-sm">
                Status: Disconnected
            </div>

            <button id="connect" class="w-full py-4 bg-amber-500 hover:bg-amber-600 text-black font-bold rounded-xl transition-all mb-2">
                Connect to Clock
            </button>

            <button id="disconnect" class="hidden w-full py-2 bg-red-700 hover:bg-red-800 text-white rounded-lg transition-all text-sm mb-4">
                Disconnect
            </button>

            <div class="space-y-4 opacity-50 pointer-events-none" id="controls">
                <!-- Format Toggle -->
                <div class="p-4 border border-neutral-800 rounded-lg">
                    <label class="block text-sm mb-3 text-neutral-400">Display Format</label>
                    <div class="flex items-center justify-between">
                        <span class="text-sm">24-Hour</span>
                        <input type="checkbox" id="format12h" class="toggle-input">
                        <span class="text-sm">12-Hour</span>
                    </div>
                    <div class="text-center text-xs text-neutral-500 mt-2">Current: <span id="formatDisplay">24-Hour</span></div>
                </div>

                <!-- Timezone Selector -->
                <div class="p-4 border border-neutral-800 rounded-lg">
                    <label class="block text-sm mb-2 text-neutral-400">Region & Timezone</label>
                    <select id="timezone" class="w-full bg-neutral-800 text-amber-500 border border-neutral-700 rounded-lg p-2 text-sm">
                        <option value="0">UTC (No DST)</option>
                        <optgroup label="USA">
                            <option value="1">Eastern (EST/EDT)</option>
                            <option value="2">Central (CST/CDT)</option>
                            <option value="3">Mountain (MST/MDT)</option>
                            <option value="4">Pacific (PST/PDT)</option>
                        </optgroup>
                        <optgroup label="Canada">
                            <option value="5">Atlantic (AST/ADT)</option>
                            <option value="6">Eastern (EST/EDT)</option>
                            <option value="7">Central (CST/CDT)</option>
                            <option value="8">Mountain (no DST)</option>
                            <option value="9">Pacific (PST/PDT)</option>
                        </optgroup>
                        <optgroup label="Europe">
                            <option value="10">London (GMT/BST)</option>
                            <option value="14">Central European (CET/CEST)</option>
                            <option value="15">Eastern European (EET/EEST)</option>
                        </optgroup>
                        <optgroup label="Australia & New Zealand">
                            <option value="16">Sydney (AEDT/AEST)</option>
                            <option value="17">Adelaide (ACDT/ACST)</option>
                            <option value="18">Perth (no DST)</option>
                            <option value="19">New Zealand (NZDT/NZST)</option>
                        </optgroup>
                        <optgroup label="South America">
                            <option value="20">Brazil Sao Paulo (BRT/BRST)</option>
                        </optgroup>
                        <optgroup label="No DST (Year-Round Standard Time)">
                            <option value="11">Arizona (MST)</option>
                            <option value="12">Hawaii (HST)</option>
                            <option value="13">Samoa (WST)</option>
                        </optgroup>
                    </select>
                    <div class="text-center text-xs text-neutral-500 mt-2">Selected: <span id="tzDisplay">UTC</span></div>
                </div>
                
                <!-- Brightness Control -->
                <div class="p-4 border border-neutral-800 rounded-lg">
                    <label class="block text-sm mb-2 text-neutral-400">Display Brightness</label>
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-neutral-500">Low</span>
                        <input type="range" id="brightness" min="0" max="7" value="5" class="flex-1 h-2 bg-neutral-800 rounded-lg appearance-none cursor-pointer accent-amber-500">
                        <span class="text-xs text-neutral-500">High</span>
                    </div>
                    <div class="text-center text-xs text-neutral-400 mt-2">Level: <span id="brightnessValue">5</span></div>
                </div>

                <!-- Scheduled Brightness Dimming -->
                <div class="p-4 border border-amber-800 rounded-lg">
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm text-neutral-400">Scheduled Dimming</label>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-neutral-500">Off</span>
                            <input type="checkbox" id="scheduleEnabled" class="toggle-input">
                            <span class="text-xs text-neutral-500">On</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <!-- Dim/Night Settings -->
                        <div class="p-3 bg-neutral-900 rounded border border-neutral-800">
                            <div class="text-xs text-neutral-500 mb-2 font-semibold">Night (Dim)</div>
                            <div class="space-y-2">
                                <div>
                                    <label class="text-xs text-neutral-500">Time</label>
                                    <input type="time" id="dimTime" value="22:00" class="w-full bg-neutral-800 text-amber-500 border border-neutral-700 rounded px-2 py-1 text-xs">
                                </div>
                                <div>
                                    <label class="text-xs text-neutral-500">Brightness</label>
                                    <input type="range" id="dimBrightness" min="0" max="7" value="1" class="w-full h-1 bg-neutral-700 rounded appearance-none cursor-pointer accent-blue-500">
                                    <div class="text-center text-xs text-neutral-400 mt-1"><span id="dimBrightnessValue">1</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bright/Day Settings -->
                        <div class="p-3 bg-neutral-900 rounded border border-neutral-800">
                            <div class="text-xs text-neutral-500 mb-2 font-semibold">Day (Bright)</div>
                            <div class="space-y-2">
                                <div>
                                    <label class="text-xs text-neutral-500">Time</label>
                                    <input type="time" id="brightTime" value="07:00" class="w-full bg-neutral-800 text-amber-500 border border-neutral-700 rounded px-2 py-1 text-xs">
                                </div>
                                <div>
                                    <label class="text-xs text-neutral-500">Brightness</label>
                                    <input type="range" id="brightBrightness" min="0" max="7" value="5" class="w-full h-1 bg-neutral-700 rounded appearance-none cursor-pointer accent-amber-500">
                                    <div class="text-center text-xs text-neutral-400 mt-1"><span id="brightBrightnessValue">5</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-xs text-neutral-500 mt-3 text-center">
                        Status: <span id="scheduleStatus" class="text-amber-400">Not synced</span>
                    </div>
                </div>
                
                <div class="p-2 border border-neutral-800 rounded-lg">
                    <div class="flex justify-between items-center">
                        <div class="text-xs text-neutral-400">
                            Serial: <span id="serialLog" class="text-neutral-300">--</span>
                        </div>
                        <button id="toggleConsole" class="text-xs bg-neutral-800 hover:bg-neutral-700 text-amber-400 px-2 py-1 rounded transition-all">
                            Show Console
                        </button>
                    </div>
                    
                    <!-- Console Panel (hidden by default) -->
                    <div id="consolePanel" class="hidden mt-2 p-2 bg-neutral-950 border border-neutral-800 rounded text-xs font-mono">
                        <div id="consoleLogs" class="h-48 overflow-y-auto space-y-1 text-neutral-400">
                            <div class="text-neutral-600">Console ready...</div>
                        </div>
                        <button id="clearConsole" class="w-full mt-2 py-1 bg-neutral-800 hover:bg-neutral-700 text-neutral-300 rounded text-xs transition-all">
                            Clear Console
                        </button>
                    </div>
                </div>

                <!-- Sync Settings Button -->
                <button id="syncSettings" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg border border-blue-500 transition-all font-semibold">
                    Sync Settings to Device
                </button>
            </div>
        </div>

        <!-- Info Card -->
        <div class="card p-4 rounded-lg text-xs text-neutral-500 space-y-2">
            <p><strong>Setup:</strong> Select your region, then click "Sync Settings to Device" once.</p>
            <p><strong>Format:</strong> Toggle 12/24-hour display. Your preference is saved on the device.</p>
            <p><strong>Scheduled Dimming:</strong> Set dim (night) and bright (day) times with separate brightness levels. Schedule automatically applies based on time.</p>
            <p><strong>Auto-Increment:</strong> After setup, the device advances the date automatically each day.</p>
            <p><strong>DST:</strong> The device applies DST rules automatically based on your region—no daily syncs needed.</p>
        </div>
    </div>

    <script>
        let port;
        let writer;
        let reader;
        let isConnected = false;
        let dstTableLoaded = false;
        let dstRules = null;
        let serialRxBuffer = '';
        let isUpdatingFromDevice = false;

        const connectBtn = document.getElementById('connect');
        const disconnectBtn = document.getElementById('disconnect');
        const statusDiv = document.getElementById('status');
        const controls = document.getElementById('controls');
        const format12hToggle = document.getElementById('format12h');
        const formatDisplay = document.getElementById('formatDisplay');
        const timezoneSelect = document.getElementById('timezone');
        const tzDisplay = document.getElementById('tzDisplay');
        const brightnessSlider = document.getElementById('brightness');
        const brightnessValue = document.getElementById('brightnessValue');
        const serialLog = document.getElementById('serialLog');
        const syncSettingsBtn = document.getElementById('syncSettings');

        // Schedule elements
        const scheduleEnabledToggle = document.getElementById('scheduleEnabled');
        const dimTimeInput = document.getElementById('dimTime');
        const dimBrightnessSlider = document.getElementById('dimBrightness');
        const dimBrightnessValue = document.getElementById('dimBrightnessValue');
        const brightTimeInput = document.getElementById('brightTime');
        const brightBrightnessSlider = document.getElementById('brightBrightness');
        const brightBrightnessValue = document.getElementById('brightBrightnessValue');
        const scheduleStatus = document.getElementById('scheduleStatus');

        // Console elements
        const toggleConsoleBtn = document.getElementById('toggleConsole');
        const consolePanel = document.getElementById('consolePanel');
        const consoleLogs = document.getElementById('consoleLogs');
        const clearConsoleBtn = document.getElementById('clearConsole');
        let messageLog = [];

        async function cleanupSerialConnection() {
            try {
                if (reader) {
                    try { await reader.cancel(); } catch (_) {}
                    try { reader.releaseLock(); } catch (_) {}
                    reader = null;
                }

                if (writer) {
                    try { writer.releaseLock(); } catch (_) {}
                    writer = null;
                }

                if (port) {
                    try { await port.close(); } catch (_) {}
                    port = null;
                }
            } catch (_) {}

            isConnected = false;
            connectBtn.disabled = false;
            connectBtn.innerText = 'Connect to Clock';
            disconnectBtn.classList.add('hidden');
            controls.classList.add('opacity-50', 'pointer-events-none');
        }

        // ============= Timezone Configuration =============
        // Client-side reference only; Arduino has its own DST algorithms
        const timezoneConfig = {
            0:  { name: 'UTC', offset: 0, dstRule: 'none' },
            1:  { name: 'USA Eastern', offset: -5, dstRule: 'usa' },
            2:  { name: 'USA Central', offset: -6, dstRule: 'usa' },
            3:  { name: 'USA Mountain', offset: -7, dstRule: 'usa' },
            4:  { name: 'USA Pacific', offset: -8, dstRule: 'usa' },
            5:  { name: 'Canada Atlantic', offset: -3, dstRule: 'usa' },
            6:  { name: 'Canada Eastern', offset: -5, dstRule: 'usa' },
            7:  { name: 'Canada Central', offset: -6, dstRule: 'usa' },
            8:  { name: 'Canada Mountain', offset: -7, dstRule: 'none' },
            9:  { name: 'Canada Pacific', offset: -8, dstRule: 'usa' },
            10: { name: 'UK London', offset: 0, dstRule: 'uk' },
            11: { name: 'Arizona', offset: -7, dstRule: 'none' },
            12: { name: 'Hawaii', offset: -10, dstRule: 'none' },
            13: { name: 'Samoa', offset: -9, dstRule: 'none' },
            14: { name: 'EU Central', offset: 1, dstRule: 'uk' },
            15: { name: 'EU Eastern', offset: 2, dstRule: 'uk' },
            16: { name: 'Australia Sydney', offset: 10, dstRule: 'australia' },
            17: { name: 'Australia Adelaide', offset: 9, dstRule: 'australia' },
            18: { name: 'Australia Perth', offset: 8, dstRule: 'none' },
            19: { name: 'New Zealand', offset: 12, dstRule: 'nz' },
            20: { name: 'Brazil Sao Paulo', offset: -3, dstRule: 'brazil' }
        };

        // ============= Serial Communication =============
        function addToMessageLog(message) {
            messageLog.push(message);
            updateConsoleDisplay();
        }

        function updateConsoleDisplay() {
            consoleLogs.innerHTML = messageLog
                .map((msg, idx) => `<div><span class="text-neutral-600">[${idx + 1}]</span> ${msg}</div>`)
                .join('');
            // Auto-scroll to bottom
            consoleLogs.scrollTop = consoleLogs.scrollHeight;
        }

        function handleArduinoLine(line) {
            if (!line) return;

            console.log('Arduino response:', line);
            addToMessageLog(line);
            serialLog.innerText = line;

            if (line.startsWith('ERR:F')) {
                statusDiv.innerText = `Status: Format switch failed (${line})`;
                statusDiv.classList.remove('text-green-500');
                statusDiv.classList.add('text-red-500');
                return;
            }

            if (line.startsWith('OK:F')) {
                const applied = line.slice(4).trim();
                const formatLabel = applied === '1' ? '12-Hour' : '24-Hour';
                statusDiv.innerText = `Status: Format ACK from device: ${formatLabel}`;
                statusDiv.classList.remove('text-red-500');
                statusDiv.classList.add('text-green-500');
                return;
            }

            if (line.startsWith('OK:QF')) {
                const applied = line.slice(5).trim();
                const is12 = applied === '1';
                isUpdatingFromDevice = true;
                format12hToggle.checked = is12;
                formatDisplay.innerText = is12 ? '12-Hour' : '24-Hour';
                isUpdatingFromDevice = false;
                statusDiv.innerText = `Status: Device format is ${is12 ? '12-Hour' : '24-Hour'} (QF)`;
                statusDiv.classList.remove('text-red-500');
                statusDiv.classList.add('text-green-500');
                return;
            }

            if (line.startsWith('DBG:F')) {
                statusDiv.innerText = `Status: ${line}`;
                statusDiv.classList.remove('text-red-500');
                statusDiv.classList.add('text-green-500');
            }

            // Handle scheduled brightness query response (QS)
            if (line.startsWith('OK:QS')) {
                // Format: OK:QS enabled=1,dim=22:00:1,bright=07:00:5
                const parts = line.slice(6).trim().split(',');
                const enabledMatch = parts[0].match(/enabled=(\d)/);
                const dimMatch = parts[1].match(/dim=(\d{2}):(\d{2}):(\d)/);
                const brightMatch = parts[2].match(/bright=(\d{2}):(\d{2}):(\d)/);
                
                if (enabledMatch && dimMatch && brightMatch) {
                    isUpdatingFromDevice = true;
                    
                    const enabled = enabledMatch[1] === '1';
                    scheduleEnabledToggle.checked = enabled;
                    
                    dimTimeInput.value = `${dimMatch[1]}:${dimMatch[2]}`;
                    dimBrightnessSlider.value = dimMatch[3];
                    dimBrightnessValue.innerText = dimMatch[3];
                    
                    brightTimeInput.value = `${brightMatch[1]}:${brightMatch[2]}`;
                    brightBrightnessSlider.value = brightMatch[3];
                    brightBrightnessValue.innerText = brightMatch[3];
                    
                    scheduleStatus.innerText = enabled ? 'Enabled ✓' : 'Disabled';
                    scheduleStatus.classList.toggle('text-green-400', enabled);
                    scheduleStatus.classList.toggle('text-neutral-500', !enabled);
                    
                    isUpdatingFromDevice = false;
                    statusDiv.innerText = `Status: Schedule loaded from device`;
                    statusDiv.classList.add('text-green-500');
                }
                return;
            }

            // Handle schedule command acknowledgments
            if (line.startsWith('OK:S') || line.startsWith('OK:N') || line.startsWith('OK:Y')) {
                scheduleStatus.innerText = 'Synced ✓';
                scheduleStatus.classList.add('text-green-400');
                scheduleStatus.classList.remove('text-neutral-500');
                return;
            }
        }

        async function readLoop() {
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    const text = new TextDecoder().decode(value);
                    serialRxBuffer += text;

                    let newlineIndex;
                    while ((newlineIndex = serialRxBuffer.search(/[\r\n]/)) !== -1) {
                        const line = serialRxBuffer.slice(0, newlineIndex).trim();
                        serialRxBuffer = serialRxBuffer.slice(newlineIndex + 1);
                        handleArduinoLine(line);
                    }
                }
            } catch (err) {
                console.error('Read error:', err);
                
                // Handle buffer overrun errors by clearing buffer and restarting
                if (err.name === 'BufferOverrunError') {
                    console.warn('Buffer overrun detected - clearing buffer and restarting read loop');
                    serialRxBuffer = ''; // Clear the buffer
                    
                    try {
                        // Try to recover: cancel current reader and get a new one
                        await reader.cancel();
                        reader.releaseLock();
                        reader = port.readable.getReader();
                        
                        // Restart the read loop
                        readLoop();
                    } catch (recoveryErr) {
                        console.error('Failed to recover from buffer overrun:', recoveryErr);
                        await cleanupSerialConnection();
                        statusDiv.innerText = "Status: Disconnected (buffer overrun)";
                        statusDiv.classList.add('text-red-500');
                        statusDiv.classList.remove('text-green-500');
                    }
                }
            }
        }

        async function sendCommand(cmd) {
            try {
                console.log('Sending:', cmd.trim());
                await writer.write(new TextEncoder().encode(cmd));
            } catch (err) {
                console.error('Send error:', err);
                throw err;
            }
        }

        // ============= Event Listeners =============
        connectBtn.addEventListener('click', async () => {
            try {
                if (isConnected) {
                    await cleanupSerialConnection();
                }

                // Always prompt user to select port (don't assume existing ports)
                port = await navigator.serial.requestPort();

                await port.open({ baudRate: 9600 });
                writer = port.writable.getWriter();
                reader = port.readable.getReader();
                isConnected = true;
                
                readLoop();
                
                statusDiv.innerText = "Status: Connected ✓";
                statusDiv.classList.add('text-green-500');
                statusDiv.classList.remove('text-neutral-400');
                controls.classList.remove('opacity-50', 'pointer-events-none');
                connectBtn.innerText = "Reconnect";
                connectBtn.disabled = false;
                disconnectBtn.classList.remove('hidden');
                
                // Update timezone display
                updateTimezoneDisplay();
                await sendCommand('QF\n');
                await new Promise(r => setTimeout(r, 50));
                await sendCommand('QS\n');

            } catch (err) {
                statusDiv.innerText = "Error: " + err.message;
                statusDiv.classList.add('text-red-500');
            }
        });

        disconnectBtn.addEventListener('click', async () => {
            await cleanupSerialConnection();
            statusDiv.innerText = "Status: Disconnected";
            statusDiv.classList.remove('text-green-500');
            statusDiv.classList.add('text-neutral-400');
        });

        if (navigator.serial) {
            navigator.serial.addEventListener('disconnect', async () => {
                serialLog.innerText = 'Device disconnected';
                statusDiv.innerText = 'Status: Device disconnected. Click Connect.';
                statusDiv.classList.remove('text-green-500');
                statusDiv.classList.add('text-red-500');
                disconnectBtn.classList.add('hidden');
                await cleanupSerialConnection();
            });
        }

        format12hToggle.addEventListener('change', (e) => {
            if (isUpdatingFromDevice) {
                return;
            }
            const formatLabel = e.target.checked ? '12-Hour' : '24-Hour';
            formatDisplay.innerText = formatLabel;
            localStorage.setItem('format12h', e.target.checked ? '1' : '0');
        });

        timezoneSelect.addEventListener('change', (e) => {
            const option = e.target.options[e.target.selectedIndex];
            tzDisplay.innerText = option.text;
            localStorage.setItem('timezone', e.target.value);
        });

        brightnessSlider.addEventListener('input', (e) => {
            brightnessValue.innerText = e.target.value;
        });

        // Schedule brightness display updates (input only, no auto-sync)
        dimBrightnessSlider.addEventListener('input', (e) => {
            dimBrightnessValue.innerText = e.target.value;
        });

        brightBrightnessSlider.addEventListener('input', (e) => {
            brightBrightnessValue.innerText = e.target.value;
        });

        // Console toggle
        toggleConsoleBtn.addEventListener('click', () => {
            consolePanel.classList.toggle('hidden');
            toggleConsoleBtn.innerText = consolePanel.classList.contains('hidden') ? 'Show Console' : 'Hide Console';
        });

        clearConsoleBtn.addEventListener('click', () => {
            messageLog = [];
            consoleLogs.innerHTML = '<div class="text-neutral-600">Console cleared...</div>';
        });

        async function syncScheduleSettings() {
            try {
                scheduleStatus.innerText = 'Syncing...';
                
                // Parse dim time
                const [dimH, dimM] = dimTimeInput.value.split(':').map(v => parseInt(v));
                const dimB = parseInt(dimBrightnessSlider.value);
                
                // Parse bright time
                const [brightH, brightM] = brightTimeInput.value.split(':').map(v => parseInt(v));
                const brightB = parseInt(brightBrightnessSlider.value);
                
                // Send commands
                await sendCommand(`N${dimH},${dimM},${dimB}\n`);
                await new Promise(r => setTimeout(r, 50));
                await sendCommand(`Y${brightH},${brightM},${brightB}\n`);
                
            } catch (err) {
                console.error('Schedule sync error:', err);
                scheduleStatus.innerText = 'Sync failed';
                scheduleStatus.classList.remove('text-green-400');
                scheduleStatus.classList.add('text-red-400');
            }
        }

        syncSettingsBtn.addEventListener('click', async () => {
            try {
                syncSettingsBtn.disabled = true;
                statusDiv.innerText = "Status: Syncing settings...";
                statusDiv.classList.remove('text-red-500');
                statusDiv.classList.add('text-green-500');

                const format = format12hToggle.checked ? 1 : 0;
                const brightness = parseInt(brightnessSlider.value);
                const timezoneId = parseInt(timezoneSelect.value);
                const now = new Date();
                const h = now.getHours();
                const m = now.getMinutes();
                const s = now.getSeconds();
                const month = now.getMonth() + 1;
                const day = now.getDate();
                const year = now.getFullYear();

                // Send all settings in sequence
                // Note: Z command now takes timezone ID (0-10) instead of offset
                await sendCommand(`D${month},${day},${year}\n`);
                await new Promise(r => setTimeout(r, 50));

                await sendCommand(`T${h},${m},${s}\n`);
                await new Promise(r => setTimeout(r, 50));

                await sendCommand(`F${format}\n`);
                await new Promise(r => setTimeout(r, 50));

                await sendCommand(`Z${timezoneId}\n`);
                await new Promise(r => setTimeout(r, 50));

                await sendCommand(`B${brightness}\n`);
                await new Promise(r => setTimeout(r, 50));

                // Send schedule settings
                const scheduleEnabled = scheduleEnabledToggle.checked ? 1 : 0;
                await sendCommand(`S${scheduleEnabled}\n`);
                await new Promise(r => setTimeout(r, 50));
                
                await syncScheduleSettings();
                await new Promise(r => setTimeout(r, 50));

                await sendCommand('QF\n');
                await new Promise(r => setTimeout(r, 50));
                await sendCommand('QS\n');

                const tzName = timezoneConfig[timezoneId]?.name || 'Unknown';
                statusDiv.innerText = `Status: Synced to ${tzName}! ${month}/${day}/${year} ${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                statusDiv.classList.remove('text-red-500');
                statusDiv.classList.add('text-green-500');
                serialLog.innerText = 'done';

            } catch (err) {
                console.error('Sync error:', err);
                statusDiv.innerText = "Status: Sync failed - " + err.message;
                statusDiv.classList.remove('text-green-500');
                statusDiv.classList.add('text-red-500');
                serialLog.innerText = 'error';
            } finally {
                syncSettingsBtn.disabled = false;
            }
        });

        // ============= Initialization =============
        function updateTimezoneDisplay() {
            const tz = localStorage.getItem('timezone') || '0';
            timezoneSelect.value = tz;
            const tzId = parseInt(tz);
            tzDisplay.innerText = timezoneConfig[tzId]?.name || 'Unknown';
        }

        function restoreSavedPreferences() {
            const savedFormat = localStorage.getItem('format12h');
            if (savedFormat === '1') {
                format12hToggle.checked = true;
                formatDisplay.innerText = '12-Hour';
            } else {
                format12hToggle.checked = false;
                formatDisplay.innerText = '24-Hour';
            }
            
            updateTimezoneDisplay();
            
            // Update DST display based on user's current system timezone
            // (Device will use its own algorithm when synced)
        }

        // Load saved preferences on page load
        restoreSavedPreferences();
    </script>
</body>
</html>
